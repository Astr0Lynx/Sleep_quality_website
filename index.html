<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Quality Monitoring - Nap Detection Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dark-mode.css">
</head>
<body>
    <header>
        <h1>Sleep Quality Monitoring Dashboard</h1>
        <p>Short Nap & Desk-Sleep Detection for Campus Environments</p>
    </header>

    <nav>
        <ul>
            <li><a href="index.html" class="active">Home</a></li>
            <li><a href="subject1.html">Subject 1</a></li>
            <li><a href="subject2.html">Subject 2</a></li>
            <li><a href="subject3.html">Subject 3</a></li>
            <li><a href="subject4.html">Subject 4</a></li>
            <li><a href="summaries.html">Summaries</a></li>
        </ul>
    </nav>

    <main>
        <!-- Project Introduction -->
        <section class="intro">
            <h2>Project Overview</h2>
            <p>Non-intrusive wearable system for monitoring short naps and desk-sleep in classroom/workspace environments using multi-sensor biometric data.</p>
            
            <div class="project-overview">
                <div class="overview-grid">
                    <div class="overview-item">
                        <h3>ðŸ’¤ Short Nap Focus</h3>
                        <ul>
                            <li>Desk-sleep detection system</li>
                            <li>Realistic campus testing</li>
                            <li>Classroom drowsiness monitoring</li>
                        </ul>
                    </div>
                    <div class="overview-item">
                        <h3>ðŸ“Š Multi-Signal Analysis</h3>
                        <ul>
                            <li>Muscle activity (EMG sensor)</li>
                            <li>Heart rate (ECG sensor)</li>
                            <li>Oxygen levels (SpO2 sensor)</li>
                            <li>Body movement (IMU sensor)</li>
                        </ul>
                    </div>
                    <div class="overview-item">
                        <h3>ðŸ”¬ Volunteer Testing</h3>
                        <ul>
                            <li>Real data from test subjects</li>
                            <li>ThingSpeak IoT integration</li>
                            <li>Comprehensive sleep stage mapping</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Navigation Dashboard -->
        <section class="dashboard">
            <h2>Dashboard Sections</h2>
            
            <div class="project-cards">
                <div class="project-card">
                    <h3>Subject Data</h3>
                    <ul>
                        <li>Individual sleep monitoring</li>
                        <li>Baseline measurements</li>
                        <li>Nap session analysis</li>
                    </ul>
                    <div class="card-actions">
                        <a href="subject1.html" class="btn">Subject 1</a>
                        <a href="subject2.html" class="btn btn-secondary">Subject 2</a>
                        <a href="subject3.html" class="btn btn-accent">Subject 3</a>
                        <a href="subject4.html" class="btn">Subject 4</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Technical Overview -->
        <section class="technical-overview">
            <h2>Technical Specifications</h2>
            <div class="tech-grid">
                <div class="tech-item">
                    <h4>Sensors</h4>
                    <ul>
                        <li>EMG sensor (Muscle Sensor v3)</li>
                        <li>ECG sensor (AD8232)</li>
                        <li>SpO2 sensor (MAX30102)</li>
                        <li>IMU sensor (MPU6080)</li>
                    </ul>
                </div>
                <div class="tech-item">
                    <h4>System Design</h4>
                    <ul>
                        <li>ESP32 microcontroller</li>
                        <li>3 PCB modules (sensors + power)</li>
                        <li>Wearable backpack-mounted design</li>
                        <li>Calibrated against smartwatch</li>
                        <li>ECG sampling at 250 Hz</li>
                    </ul>
                </div>
                <div class="tech-item">
                    <h4>Data Platform</h4>
                    <ul>
                        <li>ThingSpeak IoT integration</li>
                        <li>8-channel data streaming</li>
                        <li>Real-time web dashboard</li>
                        <li>Multi-subject monitoring</li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="config-section">
            <h2>ThingSpeak Configuration</h2>
            <p>System configured for real-time data collection from ThingSpeak platform.</p>
            <div class="config-info">
                <div class="info-item">
                    <strong>Channel ID:</strong>
                    <span>3188672</span>
                </div>
                <div class="info-item">
                    <strong>Data Fields:</strong>
                    <ul>
                        <li>Field 1: BPM</li>
                        <li>Field 2: SpO2</li>
                        <li>Field 3: ECG</li>
                        <li>Field 4: Temperature (unused)</li>
                        <li>Field 5: EMG</li>
                        <li>Field 6: MPU</li>
                        <li>Field 7: User ID (1-4)</li>
                        <li>Field 8: Session ID (0=baseline, 1-3=sleep)</li>
                    </ul>
                </div>
                <div class="info-item">
                    <strong>Status:</strong> <span id="connectionStatus" class="status-ready">Checking...</span>
                </div>
            </div>
        </section>

        <!-- Live Data Feed Section -->
        <section class="live-data-section">
            <h2>Live Data Feed</h2>
            <div id="liveDataStatus" class="loading">Connecting to ThingSpeak...</div>
            <div id="liveDataDisplay" style="display:none;">
                <div class="data-grid">
                    <div class="data-card">
                        <h4>Latest Reading</h4>
                        <p id="latestTimestamp">--</p>
                    </div>
                    <div class="data-card">
                        <h4>Heart Rate (BPM)</h4>
                        <p id="latestBPM" class="data-value">--</p>
                    </div>
                    <div class="data-card">
                        <h4>SpO2 (%)</h4>
                        <p id="latestSpO2" class="data-value">--</p>
                    </div>
                    <div class="data-card">
                        <h4>Temperature (Â°C)</h4>
                        <p id="latestTemp" class="data-value">--</p>
                    </div>
                    <div class="data-card">
                        <h4>Total Data Points</h4>
                        <p id="totalDataPoints" class="data-value">--</p>
                    </div>
                    <div class="data-card">
                        <h4>Active User</h4>
                        <p id="latestUser" class="data-value">--</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Sleep Quality Research Project</p>
    </footer>

    <script src="config.js"></script>
    <script src="thingspeak.js"></script>
    <script src="real-time-data.js"></script>
    <script src="animations.js"></script>
    <script src="data-visualization.js"></script>
    <script src="dynamic-enhancements.js"></script>
    <script>
        // Initialize live data feed on index page
        async function initializeLiveData() {
            const statusElement = document.getElementById('liveDataStatus');
            const displayElement = document.getElementById('liveDataDisplay');
            const connectionStatus = document.getElementById('connectionStatus');
            
            try {
                connectionStatus.textContent = 'Connecting...';
                connectionStatus.className = 'status-warning';
                
                // Create ThingSpeak API instance
                const api = new ThingSpeakAPI();
                
                // Fetch latest data
                const data = await api.fetchData(10);
                
                if (data && data.feeds && data.feeds.length > 0) {
                    // Get the most recent entry
                    const latest = data.feeds[data.feeds.length - 1];
                    
                    // Update display
                    document.getElementById('latestTimestamp').textContent = 
                        new Date(latest.created_at).toLocaleString();
                    document.getElementById('latestBPM').textContent = latest.field1 || '--';
                    document.getElementById('latestSpO2').textContent = latest.field2 || '--';
                    document.getElementById('latestTemp').textContent = latest.field4 || '--';
                    document.getElementById('totalDataPoints').textContent = data.feeds.length;
                    document.getElementById('latestUser').textContent = 
                        latest.field7 ? `Subject ${latest.field7}` : '--';
                    
                    // Hide loading, show data
                    statusElement.style.display = 'none';
                    displayElement.style.display = 'block';
                    
                    // Update connection status
                    connectionStatus.textContent = 'Connected';
                    connectionStatus.className = 'status-ready';
                    
                    console.log('Successfully loaded ThingSpeak data:', {
                        channel: data.channel?.name,
                        entries: data.feeds.length,
                        latest: latest.created_at
                    });
                } else {
                    throw new Error('No data available from ThingSpeak channel');
                }
            } catch (error) {
                console.error('Error loading ThingSpeak data:', error);
                
                const isLocalhost = window.location.hostname === 'localhost' || 
                                  window.location.hostname === '127.0.0.1';
                
                if (isLocalhost) {
                    // On localhost, show the actual error so you can debug
                    statusElement.innerHTML = `
                        <div class="error">
                            <strong>Connection Error:</strong> ${error.message}<br>
                            <small>Please check your internet connection and ThingSpeak API settings.</small>
                        </div>
                    `;
                    statusElement.className = 'error';
                    connectionStatus.textContent = 'Error';
                    connectionStatus.className = 'status-error';
                } else {
                    // For deployed site, silently hide the error - just show dashes
                    statusElement.style.display = 'none';
                    displayElement.style.display = 'block';
                    connectionStatus.textContent = 'Offline';
                    connectionStatus.className = 'status-warning';
                    
                    // Show placeholder dashes for all fields
                    document.getElementById('latestTimestamp').textContent = '--';
                    document.getElementById('latestBPM').textContent = '--';
                    document.getElementById('latestSpO2').textContent = '--';
                    document.getElementById('latestTemp').textContent = '--';
                    document.getElementById('totalDataPoints').textContent = '--';
                    document.getElementById('latestUser').textContent = '--';
                }
            }
        }
        
        // Load data when page is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLiveData);
        } else {
            initializeLiveData();
        }
    </script>
</body>
</html>
