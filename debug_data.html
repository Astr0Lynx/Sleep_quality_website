<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug ThingSpeak Data</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4fc3f7;
        }
        .section {
            background: #2d2d2d;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #4fc3f7;
        }
        .error {
            border-left-color: #f44336;
        }
        .success {
            border-left-color: #4caf50;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .btn {
            background: #4fc3f7;
            color: #1e1e1e;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        .btn:hover {
            background: #29b6f6;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        th {
            background: #4fc3f7;
            color: #1e1e1e;
            font-weight: bold;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status.loading { background: #ff9800; color: #000; }
        .status.success { background: #4caf50; color: #fff; }
        .status.error { background: #f44336; color: #fff; }
    </style>
</head>
<body>
    <h1>üîç ThingSpeak Data Debug Tool</h1>
    
    <div class="section">
        <h2>Connection Status</h2>
        <p>Status: <span id="status" class="status loading">Checking...</span></p>
        <p>Channel ID: <strong>3188672</strong></p>
        <p>API Key: <strong>W1N28S1IJEC81SI6</strong></p>
        <p>Python API: <span id="apiStatus" class="status loading">Checking...</span></p>
    </div>

    <div class="section">
        <h2>Controls</h2>
        <button class="btn" onclick="testPythonAPI()">Test Python API</button>
        <button class="btn" onclick="fetchRawData()">Fetch Raw Data</button>
        <button class="btn" onclick="analyzeData()">Analyze by Subject</button>
        <button class="btn" onclick="showLatestReadings()">Show Latest Readings</button>
        <button class="btn" onclick="clearOutput()">Clear Output</button>
    </div>

    <div id="output"></div>

    <script src="config.js"></script>
    <script src="thingspeak.js"></script>
    <script>
        let api;
        let rawData;

        async function init() {
            try {
                api = new ThingSpeakAPI();
                document.getElementById('status').textContent = 'Ready';
                document.getElementById('status').className = 'status success';
                
                // Test Python API
                await testPythonAPIStatus();
                
                // Auto-fetch on load
                await fetchRawData();
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
                document.getElementById('status').className = 'status error';
            }
        }

        async function testPythonAPIStatus() {
            try {
                const response = await fetch('http://localhost:5000/api/status');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('apiStatus').textContent = 'Connected ‚úì';
                    document.getElementById('apiStatus').className = 'status success';
                    console.log('Python API Status:', data);
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'Not Running';
                document.getElementById('apiStatus').className = 'status error';
                console.warn('Python API not available:', error);
            }
        }

        async function testPythonAPI() {
            const output = document.getElementById('output');
            output.innerHTML = '<div class="section"><h2>‚è≥ Testing Python API...</h2></div>';
            
            try {
                // Test status endpoint
                const statusResponse = await fetch('http://localhost:5000/api/status');
                const statusData = await statusResponse.json();
                
                // Test subjects endpoint
                const subjectsResponse = await fetch('http://localhost:5000/api/subjects');
                const subjectsData = await subjectsResponse.json();
                
                // Test latest endpoint
                const latestResponse = await fetch('http://localhost:5000/api/latest');
                const latestData = await latestResponse.json();
                
                const section = document.createElement('div');
                section.className = 'section success';
                section.innerHTML = `
                    <h2>‚úÖ Python API Test Results</h2>
                    
                    <h3>Status Endpoint</h3>
                    <pre>${JSON.stringify(statusData, null, 2)}</pre>
                    
                    <h3>Subjects Summary</h3>
                    <p><strong>Total Feeds:</strong> ${subjectsData.totalFeeds}</p>
                    <p><strong>Subjects Available:</strong> ${Object.keys(subjectsData.subjects || {}).join(', ')}</p>
                    
                    <h3>Latest Readings</h3>
                    <pre>${JSON.stringify(latestData, null, 2)}</pre>
                    
                    <h3>Full Subjects Data</h3>
                    <details>
                        <summary>Click to expand</summary>
                        <pre>${JSON.stringify(subjectsData, null, 2)}</pre>
                    </details>
                `;
                
                output.innerHTML = '';
                output.appendChild(section);
                
                document.getElementById('apiStatus').textContent = 'Connected ‚úì';
                document.getElementById('apiStatus').className = 'status success';
                
            } catch (error) {
                output.innerHTML = `
                    <div class="section error">
                        <h2>‚ùå Python API Error</h2>
                        <p>${error.message}</p>
                        <p><strong>Make sure the Python API server is running:</strong></p>
                        <pre>cd "/home/khushi/collegee/sem3/Embedded Systems Workshop/Sleep_quality_website"
source venv/bin/activate
python3 api_server.py</pre>
                    </div>
                `;
                
                document.getElementById('apiStatus').textContent = 'Error';
                document.getElementById('apiStatus').className = 'status error';
            }
        }

        async function fetchRawData() {
            const output = document.getElementById('output');
            output.innerHTML = '<div class="section"><h2>‚è≥ Fetching data...</h2></div>';
            
            try {
                rawData = await api.fetchData(100);
                
                const section = document.createElement('div');
                section.className = 'section success';
                section.innerHTML = `
                    <h2>‚úÖ Raw Data Fetched</h2>
                    <p><strong>Channel:</strong> ${rawData.channel?.name || 'Unknown'}</p>
                    <p><strong>Total Feeds:</strong> ${rawData.feeds?.length || 0}</p>
                    <p><strong>Created:</strong> ${rawData.channel?.created_at || 'N/A'}</p>
                    <p><strong>Last Entry:</strong> ${rawData.channel?.last_entry_id || 'N/A'}</p>
                    
                    <h3>Field Mapping:</h3>
                    <ul>
                        <li><strong>Field 1:</strong> BPM (Heart Rate)</li>
                        <li><strong>Field 2:</strong> SpO2 (Blood Oxygen)</li>
                        <li><strong>Field 3:</strong> ECG</li>
                        <li><strong>Field 4:</strong> Temperature</li>
                        <li><strong>Field 5:</strong> EMG</li>
                        <li><strong>Field 6:</strong> MPU (Motion)</li>
                        <li><strong>Field 7:</strong> UserID (Subject ID)</li>
                        <li><strong>Field 8:</strong> SessionID (0=baseline, 1-3=naps)</li>
                    </ul>
                    
                    <h3>Sample Data (First 5 entries):</h3>
                    <pre>${JSON.stringify(rawData.feeds?.slice(0, 5) || [], null, 2)}</pre>
                    
                    <h3>Full Data:</h3>
                    <details>
                        <summary>Click to expand all ${rawData.feeds?.length || 0} entries</summary>
                        <pre>${JSON.stringify(rawData, null, 2)}</pre>
                    </details>
                `;
                
                output.innerHTML = '';
                output.appendChild(section);
                
                document.getElementById('status').textContent = 'Data Loaded';
                document.getElementById('status').className = 'status success';
                
            } catch (error) {
                output.innerHTML = `
                    <div class="section error">
                        <h2>‚ùå Fetch Error</h2>
                        <p>${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
                document.getElementById('status').textContent = 'Fetch Failed';
                document.getElementById('status').className = 'status error';
            }
        }

        async function analyzeData() {
            if (!rawData || !rawData.feeds) {
                alert('Please fetch data first!');
                return;
            }

            const output = document.getElementById('output');
            output.innerHTML = '<div class="section"><h2>‚è≥ Analyzing data...</h2></div>';

            try {
                const allData = await api.getAllSubjectsData();
                
                const section = document.createElement('div');
                section.className = 'section success';
                
                let html = `
                    <h2>üìä Data Analysis by Subject</h2>
                    <p><strong>Total Entries:</strong> ${allData.totalFeeds}</p>
                `;

                for (let subjectId = 1; subjectId <= 3; subjectId++) {
                    const subjectData = allData.subjects[subjectId];
                    
                    html += `
                        <div class="section">
                            <h3>Subject ${subjectId}</h3>
                            <table>
                                <tr>
                                    <th>Session</th>
                                    <th>Score</th>
                                    <th>Data Points</th>
                                    <th>Latest Reading</th>
                                </tr>
                                <tr>
                                    <td>Baseline</td>
                                    <td>${subjectData.baseline?.value?.toFixed(1) || 'No data'}</td>
                                    <td>${subjectData.baseline?.dataPoints || 0}</td>
                                    <td>${subjectData.baseline?.timestamp ? new Date(subjectData.baseline.timestamp).toLocaleString() : 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Nap 1</td>
                                    <td>${subjectData.nap1?.value?.toFixed(1) || 'No data'}</td>
                                    <td>${subjectData.nap1?.dataPoints || 0}</td>
                                    <td>${subjectData.nap1?.timestamp ? new Date(subjectData.nap1.timestamp).toLocaleString() : 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Nap 2</td>
                                    <td>${subjectData.nap2?.value?.toFixed(1) || 'No data'}</td>
                                    <td>${subjectData.nap2?.dataPoints || 0}</td>
                                    <td>${subjectData.nap2?.timestamp ? new Date(subjectData.nap2.timestamp).toLocaleString() : 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Nap 3</td>
                                    <td>${subjectData.nap3?.value?.toFixed(1) || 'No data'}</td>
                                    <td>${subjectData.nap3?.dataPoints || 0}</td>
                                    <td>${subjectData.nap3?.timestamp ? new Date(subjectData.nap3.timestamp).toLocaleString() : 'N/A'}</td>
                                </tr>
                            </table>
                            <p><strong>Total Raw Data Points:</strong> ${subjectData.rawData?.length || 0}</p>
                            ${subjectData.rawData?.length > 0 ? `
                                <details>
                                    <summary>View Raw Data for Subject ${subjectId}</summary>
                                    <pre>${JSON.stringify(subjectData.rawData, null, 2)}</pre>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }
                
                section.innerHTML = html;
                output.innerHTML = '';
                output.appendChild(section);
                
            } catch (error) {
                output.innerHTML = `
                    <div class="section error">
                        <h2>‚ùå Analysis Error</h2>
                        <p>${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        async function showLatestReadings() {
            if (!rawData || !rawData.feeds || rawData.feeds.length === 0) {
                alert('Please fetch data first!');
                return;
            }

            const output = document.getElementById('output');
            const latest = rawData.feeds[rawData.feeds.length - 1];
            
            const section = document.createElement('div');
            section.className = 'section success';
            section.innerHTML = `
                <h2>üî¥ Latest Reading</h2>
                <table>
                    <tr><th>Field</th><th>Value</th></tr>
                    <tr><td>Entry ID</td><td>${latest.entry_id}</td></tr>
                    <tr><td>Timestamp</td><td>${new Date(latest.created_at).toLocaleString()}</td></tr>
                    <tr><td>BPM (Heart Rate)</td><td>${latest.field1 || 'N/A'}</td></tr>
                    <tr><td>SpO2 (Blood Oxygen)</td><td>${latest.field2 || 'N/A'}</td></tr>
                    <tr><td>ECG</td><td>${latest.field3 || 'N/A'}</td></tr>
                    <tr><td>Temperature</td><td>${latest.field4 || 'N/A'}</td></tr>
                    <tr><td>EMG</td><td>${latest.field5 || 'N/A'}</td></tr>
                    <tr><td>MPU (Motion)</td><td>${latest.field6 || 'N/A'}</td></tr>
                    <tr><td>UserID (Subject)</td><td>${latest.field7 || 'N/A'}</td></tr>
                    <tr><td>SessionID</td><td>${latest.field8 || 'N/A'}</td></tr>
                </table>
                
                <h3>Raw JSON:</h3>
                <pre>${JSON.stringify(latest, null, 2)}</pre>
            `;
            
            output.innerHTML = '';
            output.appendChild(section);
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
